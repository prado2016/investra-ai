name: Deploy to RHEL VM

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.RHEL_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.RHEL_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to RHEL via SSH
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.RHEL_USER }}@${{ secrets.RHEL_HOST }} << 'EOF'
            cd /opt/investra-ai  # Path to the cloned repo
            git pull origin main
            npm install
            npm run build
            pm2 serve dist 3000 --spa --name investra-ai --update-env  # Optional

            # Create systemd unit file for Nginx
            sudo tee /etc/systemd/system/investra-ai.service > /dev/null << 'UNIT_EOF'
            [Unit]
            Description=Investra AI Static Site
            After=network.target

            [Service]
            Type=simple
            ExecStart=/usr/sbin/nginx -g 'daemon off;'
            ExecReload=/bin/kill -HUP $MAINPID
            ExecStop=/bin/kill -s QUIT $MAINPID
            Restart=always

            [Install]
            WantedBy=multi-user.target
            UNIT_EOF

            # Create Nginx configuration for serving Vite-built static files
            sudo tee /etc/nginx/conf.d/investra-ai.conf > /dev/null << 'NGINX_EOF'
            server {
                listen 80;
                server_name _;

                root /var/www/investra-ai/dist;
                index index.html;

                location / {
                    try_files $uri $uri/ /index.html;
                }
            }
            NGINX_EOF

            # Reload systemd and enable the service
            sudo systemctl daemon-reload
            sudo systemctl enable investra-ai.service
            sudo systemctl restart investra-ai.service
            sudo systemctl restart nginx
          EOF