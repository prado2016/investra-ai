# ğŸ“§ Email Server Setup Guide

## Quick Start (5 minutes)

### Step 1: Navigate to Email Server Directory
```bash
cd /Users/eduardo/investra-ai/email-server
```

### Step 2: Run Setup Script
```bash
chmod +x setup.sh
./setup.sh
```

### Step 3: Start Email Server
```bash
./start-mailserver.sh
```

### Step 4: Verify Setup
```bash
./test-email.sh
```

## ğŸ“‹ What Gets Created

### Email Account
- **Email**: `transactions@investra.com`
- **Password**: `InvestraSecure2025!`
- **IMAP**: `localhost:993` (SSL)
- **SMTP**: `localhost:587` (STARTTLS)

### Docker Services
- **mailserver**: Main email server (docker-mailserver)
- **mailserver-admin**: Web interface at http://localhost:8080

### Directory Structure
```
email-server/
â”œâ”€â”€ docker-compose.yml          # Main container config
â”œâ”€â”€ setup.sh                   # Setup script
â”œâ”€â”€ start-mailserver.sh        # Start server
â”œâ”€â”€ stop-mailserver.sh         # Stop server
â”œâ”€â”€ test-email.sh              # Test connectivity
â”œâ”€â”€ .env                       # Environment variables
â””â”€â”€ docker-data/               # Email data storage
    â””â”€â”€ dms/
        â”œâ”€â”€ mail-data/         # Email storage
        â”œâ”€â”€ mail-state/        # Server state
        â”œâ”€â”€ mail-logs/         # Log files
        â”œâ”€â”€ config/            # Configuration
        â””â”€â”€ certs/             # SSL certificates
```

## ğŸŒ DNS Configuration (Required for Production)

### For Domain: investra.com

Add these DNS records to your domain:

```dns
# MX Record (highest priority)
@     MX  10  mail.investra.com

# A Record for mail server
mail  A       YOUR_SERVER_IP

# SPF Record (prevents spoofing)
@     TXT     "v=spf1 mx ~all"

# DMARC Record (email authentication)
_dmarc TXT    "v=DMARC1; p=quarantine; rua=mailto:dmarc@investra.com"

# DKIM Record (will be generated by mailserver)
# Check logs for the DKIM record after starting
```

## ğŸ”§ Configuration Files

### Environment Variables (.env)
```bash
# Server Details
HOSTNAME=mail.investra.com
DOMAINNAME=investra.com

# Email Credentials
MAILSERVER_USER=transactions@investra.com
MAILSERVER_PASS=InvestraSecure2025!

# Connection Settings
IMAP_HOST=localhost
IMAP_PORT=993
IMAP_TLS=true
SMTP_HOST=localhost
SMTP_PORT=587
SMTP_TLS=true
```

### Email Accounts (postfix-accounts.cf)
```
transactions@investra.com|{PLAIN}InvestraSecure2025!
```

### Email Aliases (postfix-virtual.cf)
```
wealthsimple@investra.com transactions@investra.com
imports@investra.com transactions@investra.com
noreply@investra.com transactions@investra.com
```

## ğŸš€ Testing Your Setup

### 1. Check Docker Containers
```bash
docker-compose ps
```

Expected output:
```
NAME                    IMAGE                           STATUS
mailserver              docker-mailserver:latest        Up
mailserver-admin        roundcube/roundcubemail        Up
```

### 2. Test IMAP Connection
```bash
# Using telnet
telnet localhost 993

# Using openssl
openssl s_client -connect localhost:993 -servername mail.investra.com
```

### 3. Test SMTP Connection
```bash
telnet localhost 587
```

### 4. Check Logs
```bash
# All logs
docker-compose logs

# Specific service
docker-compose logs mailserver

# Follow live logs
docker-compose logs -f mailserver
```

### 5. Send Test Email
You can use the web interface at http://localhost:8080 or any email client:

**Settings for Email Client:**
- **IMAP Server**: localhost
- **IMAP Port**: 993
- **IMAP Security**: SSL/TLS
- **SMTP Server**: localhost
- **SMTP Port**: 587
- **SMTP Security**: STARTTLS
- **Username**: transactions@investra.com
- **Password**: InvestraSecure2025!

## ğŸ”— Integration with Investra AI

### IMAP Service Configuration

The app will automatically connect to your email server using these settings:

```typescript
const imapConfig = {
  host: 'localhost',
  port: 993,
  secure: true,
  auth: {
    user: 'transactions@investra.com',
    pass: 'InvestraSecure2025!'
  }
};
```

### Starting Email Processing

1. **Start Email Server** (if not running):
   ```bash
   cd email-server
   ./start-mailserver.sh
   ```

2. **Access Email Management** in the app:
   - Navigate to **Email Import** in the sidebar
   - Go to **Overview** tab
   - Click **"Start Email Service"**

3. **Configure Wealthsimple** to send emails to:
   ```
   transactions@investra.com
   ```

## ğŸ›  Troubleshooting

### Common Issues

**1. Port Already in Use**
```bash
# Check what's using port 25
sudo lsof -i :25

# Stop conflicting service (usually postfix)
sudo systemctl stop postfix
sudo systemctl disable postfix
```

**2. Permission Denied**
```bash
# Fix script permissions
chmod +x *.sh

# Fix directory permissions
sudo chown -R $(whoami):$(whoami) docker-data/
```

**3. Docker Not Running**
```bash
# Start Docker
sudo systemctl start docker

# Enable Docker on boot
sudo systemctl enable docker
```

**4. Container Won't Start**
```bash
# Check detailed logs
docker-compose logs mailserver

# Restart specific service
docker-compose restart mailserver

# Rebuild containers
docker-compose down
docker-compose up -d --build
```

**5. Emails Not Being Received**
```bash
# Check firewall
sudo ufw status
sudo ufw allow 25
sudo ufw allow 587
sudo ufw allow 993

# Check if ports are listening
netstat -tulpn | grep -E ':(25|587|993) '
```

**6. SSL Certificate Issues**
```bash
# Generate self-signed certificates for testing
docker-compose exec mailserver bash
mkdir -p /etc/ssl/certs /etc/ssl/private
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout /etc/ssl/private/ssl-cert-snakeoil.key \
  -out /etc/ssl/certs/ssl-cert-snakeoil.pem \
  -subj "/C=US/ST=State/L=City/O=Organization/CN=mail.investra.com"
```

## ğŸ“Š Monitoring & Maintenance

### Check Email Queue
```bash
docker-compose exec mailserver postqueue -p
```

### View Mail Logs
```bash
docker-compose exec mailserver tail -f /var/log/mail/mail.log
```

### Backup Email Data
```bash
# Create backup
tar -czf email-backup-$(date +%Y%m%d).tar.gz docker-data/

# Restore backup
tar -xzf email-backup-YYYYMMDD.tar.gz
```

### Update Containers
```bash
docker-compose pull
docker-compose down
docker-compose up -d
```

## ğŸ” Security Best Practices

### 1. Use Strong Passwords
- Change default password in `postfix-accounts.cf`
- Use password manager to generate secure passwords

### 2. Enable Fail2Ban
Already configured in docker-compose.yml:
```yaml
- ENABLE_FAIL2BAN=1
```

### 3. Configure Firewall
```bash
# Allow only necessary ports
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 25    # SMTP
sudo ufw allow 587   # SMTP Submission
sudo ufw allow 993   # IMAPS
sudo ufw enable
```

### 4. Regular Updates
```bash
# Weekly update routine
docker-compose pull
docker-compose down
docker-compose up -d
```

### 5. SSL Certificates
For production, use Let's Encrypt:
```bash
# Install certbot
sudo apt install certbot

# Get certificate
sudo certbot certonly --standalone -d mail.investra.com

# Update docker-compose.yml to use real certificates
```

## ğŸ“ Support & Next Steps

### If Everything Works âœ…
1. Configure DNS records for your domain
2. Get SSL certificates for production
3. Test with real Wealthsimple emails
4. Monitor the Email Import dashboard in the app

### If You Need Help âŒ
1. Check the logs: `docker-compose logs mailserver`
2. Verify Docker is running: `docker info`
3. Test network connectivity: `telnet localhost 993`
4. Check firewall settings: `sudo ufw status`

### Integration Complete ğŸ‰
Once your email server is running:
1. Go to **Email Import** page in the app
2. Click **"Start Email Service"** 
3. Configure Wealthsimple to send emails to `transactions@investra.com`
4. Watch automated transaction imports in real-time!

---

**Status**: Your email server is now ready for automated Wealthsimple transaction processing! ğŸš€
